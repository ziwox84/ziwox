task.wait(45)
setfpscap(4)
getgenv().waitTime = 2.5

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
repeat task.wait() until player.Character
local char = player.Character
local hrp = char:WaitForChild("HumanoidRootPart")

local LocalData = require(ReplicatedStorage.Client.Framework.Services.LocalData)
local RemoteFunction = ReplicatedStorage.Shared.Framework.Network.Remote.RemoteFunction

local activeRift = nil
local lastKeyAmount = nil
local lastKeyChange = tick()

local offsets = {
    CFrame.new(0,0,0),
    CFrame.new(0,2,0),
    CFrame.new(2,0,0),
    CFrame.new(-2,0,0),
    CFrame.new(0,0,2),
    CFrame.new(0,0,-2),
}

local function getAmount(name)
    local data = LocalData:Get()
    return (data and data.Powerups and data.Powerups[name]) or 0
end

local function getAllDiceRifts()
    local t = {}
    local rendered = Workspace:FindFirstChild("Rendered")
    local rifts = rendered and rendered:FindFirstChild("Rifts")
    if not rifts then return t end
    for _, r in ipairs(rifts:GetChildren()) do
        if r.Name == "dice-rift" then
            table.insert(t, r)
        end
    end
    return t
end

local function getChestFromRift(rift)
    local chest = rift and rift:FindFirstChild("Chest", true)
    if not chest then return nil end
    return chest.PrimaryPart or chest:FindFirstChildWhichIsA("BasePart")
end

local function findAnyChest()
    for _, r in ipairs(getAllDiceRifts()) do
        local p = getChestFromRift(r)
        if p then
            return r, p
        end
    end
end

local function setNoClip(state)
    for _, v in ipairs(char:GetDescendants()) do
        if v:IsA("BasePart") then
            v.CanCollide = not state
        end
    end
end

local function teleportTo(part)
    if not part then return end
    setNoClip(true)
    hrp.CFrame = part
    RunService.Heartbeat:Wait()
    setNoClip(false)
end

local function teleportSmart(part)
    if not part then return end
    local off = offsets[math.random(1,#offsets)]
    teleportTo(part.CFrame * off)
end

local function clearRift()
    activeRift = nil
    lastKeyAmount = nil
end

task.spawn(function()
    while true do
        local rift, chest = findAnyChest()
        if rift and chest then
            activeRift = rift
            teleportSmart(chest)
        else
            clearRift()
            task.wait(math.random(1,20))
            local r2, c2 = findAnyChest()
            if not r2 then
                RemoteFunction:InvokeServer(
                    "SummonRift",
                    {
                        Name = "dice-rift",
                        Type = "Chest",
                        Time = 5,
                        World = "Minigame Paradise"
                    }
                )
            end
        end
        task.wait(2)
    end
end)

task.spawn(function()
    while true do
        if activeRift then
            local chest = getChestFromRift(activeRift)
            if not chest then
                clearRift()
            end
        end
        task.wait(1)
    end
end)

task.spawn(function()
    while true do
        if activeRift then
            local current = getAmount("Dice Key")
            if lastKeyAmount == nil then
                lastKeyAmount = current
                lastKeyChange = tick()
            elseif current ~= lastKeyAmount then
                lastKeyAmount = current
                lastKeyChange = tick()
            elseif current > 0 and tick() - lastKeyChange >= 30 then
                local chest = getChestFromRift(activeRift)
                if chest then
                    teleportSmart(chest)
                else
                    clearRift()
                end
                lastKeyChange = tick()
            end
        end
        task.wait(1)
    end
end)

task.spawn(function()
    while true do
        if activeRift and getAmount("Dice Key") > 0 then
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.R, false, game)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.R, false, game)
        end
        task.wait(0.05)
    end
end)
